# fx-cdk-recipes

Recipes for AWS infrastructure in aws-cdk + TypeScript.

AWS CDK is an infrastructure-as-code (IaC) framework that synthesizes CDK code into AWS CloudFormation templates that define CloudFormation "stacks". Stacks can be synthesized, deployed, and destroyed on target AWS environments using the `cdk` cli command.

Refer to construct and stack implementations in the `lib/` folder.

Code for lambdas + lambda layers is housed under the `src/` folder.

The code in this repo will generally apply defaults that are best suited for non-production development and proof-of-concept scenarios. The stacks and constructs should be considered a reference and source of boilerplate/starter code for various project architectures vs. production-grade infrastructure.

The code features plenty of comments that detail practical pearls and lessons learned from working with AWS + aws-cdk including notes related to stability, scalability, and security.

The `cdk.json` file includes the configuration for CDK Toolkit.

If you use this repo as the basis for a production project, remove `cdk.context.json` from `.gitignore` and commit it to your repo as currently recommended by AWS.

## Development

Install aws-cdk and aws-cli per AWS documentation. 

Configure aws-cli with your credentials such that `~/.aws/credentials` and `~/.aws/config` are populated with correct values to access your AWS account via an IAM user with sufficient permissions to create and maintain the required infrastructure.

You may also wish to install aws [amplify-cli](https://docs.amplify.aws/cli/) [ecs-cli](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_CLI_installation.html) and/or [copilot](https://aws.github.io/copilot-cli/) depending on your use-case.

Run `yarn` from the project folder to install project dependencies.

CDK requires that a global install of cdk has a version (`cdk --version`) that matches project version specified in `package.json`. You can upgrade global packages by running: `yarn global upgrad-interactive --latest`. You can upgrade packages in this project by running: `yarn upgrade-interactive --latest` from the project folder.

Remove or comment out the `cdk.context.json` entry in your `.gitignore` file. Commit this file when running aws-cdk with your own infrastructure, especially in production.

## Tips

### ACM Certificates for CloudFront

AWS CloudFront (CDN) only supports ACM certificates (SSL certificates) in the `us-east-1` region.

It is often helpful to create these certificates independent of any stacks related to project infrastructure. It can also be helpful in many scenarios to create wildcard certificates (e.g. for *.qa.example.com). In contrast to certain SSL services, Route53 + ACM only supports one level of wildcards in certificates.

An instance of an existing Certificate instance can be obtained from its ARN by calling `acm.Certificate.fromCertificateArn(...)`

### DNS and Route53

It can be helpful to create distinct hosted zones for certain project/company/org subdomains and delegate authority from the parent domain/subdomain (i.e. create an NS record for the delegated subdomain and specify the nameservers of the hosted zone).

This practice can help 'sandbox' aws-cdk development and facilitate automation-related use-cases. Importantly, it helps ensure that mistakes will not accidentally clobber essential DNS records related to production project/company/org (sub)domains.

### Long ARN Format

In the past users have reported issues with long ARN's as generated by CDK projects, particularly in relation to AWS services related to ECS. It is unconfirmed if this has since been resolved by AWS, or if it only applies to older accounts. Regardless, the following settings mitigate potential issues by enabling the long ARN format at the account level:

```sh
# remember to add --profile flag to specify a profile if your workstation has multiple profiles
aws ecs put-account-setting-default --name serviceLongArnFormat --value enabled
aws ecs put-account-setting-default --name taskLongArnFormat --value enabled
aws ecs put-account-setting-default --name containerInstanceLongArnFormat --value enabled
```

### Resource Tags

AWS Resource Tags are a best practice that should be considered in any infrastructure project. Organizations and project teams are generally advised to define and adhere to conventions that suit their needs.

Examples of tags to standardize on might include those related to team ownership, lifecycle, project + stage, cost-center, creation/destruction dates, etc.

It is also possible to create IAM policies that reference tags to allow/deny access to given resources.

## Notes

- Project dependencies include `esbuild` to support building TypeScript lambdas locally prior to upload.

## aws-cli

### Lambdas

Directly invoke a lambda with a payload and save the response:

```sh
aws lambda invoke --function-name <functionName> --payload '{}' response.json
```

Fancy:

```sh
aws lambda invoke --function-name <functionName> --cli-binary-format raw-in-base64-out --payload '{"command":"get"}' response.json response.json
```

## Useful commands

- `yarn build`   compile typescript to js
- `yarn watch`   watch for changes and compile
- `yarn test`    perform the jest unit tests

Specify the `--profile <PROFILE_NAME>` flag if you have configured multiple AWS profiles.

- `cdk deploy`   deploy this stack to your default AWS account/region
- `cdk diff`     compare deployed stack with current state
- `cdk synth`    emits the synthesized CloudFormation template
